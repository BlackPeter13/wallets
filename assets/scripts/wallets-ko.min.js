!function(a){"use strict";a(function(){function b(){var b=this;b.selectedCoin=ko.observable(),b.coins=ko.observable([]),b.loadCoins=function(){var c=[];a.ajax({dataType:"json",async:!1,cache:!0,data:{__wallets_action:"get_coins_info"},success:function(a){if("success"!=a.result)return void e(a);for(var b in a.coins)c.push(a.coins[b])},error:d}),b.coins(c),b.updateQrCode()},b.currentCoinBalance=ko.computed(function(){var a=b.coins();for(var c in a)if(a[c].symbol==b.selectedCoin())return sprintf(a[c].sprintf,a[c].balance);return""}),b.currentCoinBaseBalance=ko.computed(function(){if(walletsUserData.baseSymbol){var a=b.coins();for(var c in a)if(a[c].symbol==b.selectedCoin()&&a[c].rate)return sprintf(walletsUserData.baseSymbol+" %01.2f",a[c].balance*a[c].rate)}return""}),b.nonces=ko.computed(function(){var b=[];return a.ajax({dataType:"json",async:!1,cache:!0,data:{__wallets_action:"get_nonces"},success:function(a){return"success"!=a.result?void e(a):void(b=a.nonces)},error:d}),b}),b.updateQrCode=function(){if("undefined"!=typeof b.coins){var c=a(".dashed-slug-wallets.deposit .qrcode");c.empty();var d=b.coins();for(var e in d)if(d[e].symbol==b.selectedCoin())return void(d[e].deposit_address_qrcode_uri&&c.qrcode({text:d[e].deposit_address_qrcode_uri}))}},"function"==typeof jQuery.fn.qrcode&&b.selectedCoin.subscribe(b.updateQrCode),b.currentCoinDepositAddress=ko.computed(function(){var a=b.coins();for(var c in a)if(a[c].symbol==b.selectedCoin())return a[c].deposit_address;return""}),b.currentCoinDepositExtra=ko.computed(function(){var a=b.coins();for(var c in a)if(a[c].symbol==b.selectedCoin())return"undefined"!=typeof a[c].deposit_extra?a[c].deposit_extra:"";return""}),b.moveUser=ko.observable(),b.moveAmount=ko.observable(),b.moveBaseAmount=ko.computed(function(){var a=parseFloat(b.moveAmount());if(!isNaN(a)&&walletsUserData.baseSymbol){var c=b.coins();for(var d in c)if(c[d].symbol==b.selectedCoin()&&c[d].rate)return sprintf(walletsUserData.baseSymbol+" %01.2f",parseFloat(a)*c[d].rate)}return""}),b.moveComment=ko.observable(),b.moveFee=ko.computed(function(){var a=b.coins();for(var c in a)if(a[c].symbol==b.selectedCoin()){var d=parseFloat(a[c].move_fee);if(d+=parseFloat(a[c].move_fee_proportional)*parseFloat(b.moveAmount()),!isNaN(d)){var e=sprintf(a[c].sprintf,d),f=sprintf(walletsUserData.baseSymbol+" %01.2f",d*a[c].rate);return walletsUserData.baseSymbol&&a[c].rate?[e,f]:[e,""]}}return["",""]}),b.users=ko.computed(function(){var c=[];return a.ajax({dataType:"json",async:!1,cache:!0,data:{__wallets_action:"get_users_info"},success:function(a){if("success"!=a.result)return void e(a);for(var d in a.users)c.push(a.users[d]);c.length&&b.moveUser(c[0])},error:d}),c}),b.doMove=function(c){var e=b.moveUser().id,f=b.moveAmount(),g=b.moveComment(),h=b.selectedCoin(),i=a("input[name=__wallets_move_tags]",c).val(),j=b.nonces().do_move;a.ajax({dataType:"json",cache:!1,data:{__wallets_action:"do_move",__wallets_move_toaccount:e,__wallets_move_amount:f,__wallets_move_comment:g,__wallets_move_tags:i,__wallets_symbol:h,_wpnonce:j},success:function(d){a(c).trigger("wallets_do_move",[d,h,f,e,g]),b.loadTransactions()},error:d})},b.resetMove=function(){b.moveAmount(""),b.moveComment("")};var c=[];a.fn.walletsBindWithdrawAddressValidator=function(a,b){c.push({symbol:a,validatorFunction:b})},b.withdrawAddress=ko.observable().extend({validation:[{validator:function(a){for(var d in c)if(b.selectedCoin()==c[d].symbol){var e=c[d].validatorFunction(a);if(!e)return!1}return!0},message:wallets_ko_i18n.invalid_add}]}),b.withdrawAmount=ko.observable(),b.withdrawBaseAmount=ko.computed(function(){var a=parseFloat(b.withdrawAmount());if(!isNaN(a)&&walletsUserData.baseSymbol){var c=b.coins();for(var d in c)if(c[d].symbol==b.selectedCoin()&&c[d].rate)return sprintf(walletsUserData.baseSymbol+" %01.2f",parseFloat(b.withdrawAmount())*c[d].rate)}return""}),b.withdrawComment=ko.observable(),b.withdrawExtra=ko.observable(),b.withdrawExtraDesc=ko.computed(function(){var a=b.coins();for(var c in a)if(a[c].symbol==b.selectedCoin())return a[c].extra_desc;return!1}),b.withdrawFee=ko.computed(function(){var a=b.coins();for(var c in a)if(a[c].symbol==b.selectedCoin()){var d=parseFloat(a[c].withdraw_fee);if(d+=parseFloat(a[c].withdraw_fee_proportional)*parseFloat(b.withdrawAmount()),!isNaN(d)){var e=sprintf(a[c].sprintf,d),f=sprintf(walletsUserData.baseSymbol+" %01.2f",d*a[c].rate);return walletsUserData.baseSymbol&&a[c].rate?[e,f]:[e,""]}}return""}),b.doWithdraw=function(c){var e=b.withdrawAddress(),f=b.selectedCoin(),g=b.withdrawAmount(),h=b.withdrawComment(),i=b.withdrawExtra(),j=b.nonces().do_withdraw;a.ajax({dataType:"json",cache:!1,data:{__wallets_action:"do_withdraw",__wallets_withdraw_address:e,__wallets_symbol:f,__wallets_withdraw_amount:g,__wallets_withdraw_comment:h,__wallets_withdraw_extra:i,_wpnonce:j},success:function(d){a(c).trigger("wallets_do_withdraw",[d,f,g,e,h,i]),b.loadTransactions()},error:d})},b.resetWithdraw=function(){b.withdrawAddress(""),b.withdrawAmount(""),b.withdrawComment(""),b.withdrawExtra("")},b.currentPage=ko.observable().extend({throttle:500,notify:"always"}),b.rowsPerPage=ko.observable(10).extend({throttle:500}),b.transactions=ko.observable([]),b.loadTransactions=function(){var c=parseInt(b.currentPage()),f=b.rowsPerPage(),g=(c-1)*f,h=b.selectedCoin(),i=[];"string"==typeof h&&(isNaN(g)||(a.ajax({dataType:"json",async:!1,cache:!0,data:{__wallets_action:"get_transactions",__wallets_tx_count:f,__wallets_tx_from:g,__wallets_symbol:h},success:function(a){if("success"!=a.result)return void e(a);if(!a.transactions.length&&c>1)b.currentPage(c-1);else{i=a.transactions;var d=b.coins(),f=walletsUserData.baseSymbol+" %01.2f";for(var g in i){i[g].tx_uri="",i[g].address_uri="";for(var h in d)d[h].symbol==i[g].symbol&&("string"!=typeof i[g].amount_string&&(i[g].amount_string=sprintf(d[h].sprintf,i[g].amount)),"string"!=typeof i[g].fee_string&&(i[g].fee_string=sprintf(d[h].sprintf,i[g].fee)),walletsUserData.baseSymbol&&d[h].rate?(i[g].amount_base=sprintf(f,i[g].amount*d[h].rate),i[g].fee_base=sprintf(f,i[g].fee*d[h].rate)):i[g].amount_base=i[g].fee_base="","string"==typeof i[g].txid&&(i[g].tx_uri=sprintf(d[h].explorer_uri_tx,i[g].txid)),"string"==typeof i[g].address&&(i[g].address_uri=sprintf(d[h].explorer_uri_address,i[g].address)))}}},error:d}),b.transactions(i)))},b.selectedCoin.subscribe(b.loadTransactions),b.currentPage.subscribe(b.loadTransactions),b.rowsPerPage.subscribe(b.loadTransactions)}function c(){a(".dashed-slug-wallets select.select2-hidden-accessible").each(function(b,c){a(c).data("select2")?a(c).select2("destroy"):a(c).removeClass("select2-hidden-accessible")}),a(".dashed-slug-wallets .select2").remove()}var d=function(b,c,d){403!=b.status&&(401==b.status?a(".dashed-slug-wallets").replaceWith('<div class="dashed-slug-wallets">'+b.responseJSON.message+"</div>"):alert(sprintf(wallets_ko_i18n.contact_fail,c,d)))},e=function(a){"undefined"!=typeof a.code&&-107==a.code||"string"==typeof a.result&&("error"==a.result?alert(sprintf(wallets_ko_i18n.op_failed_msg,a.message)):alert(wallets_ko_i18n.op_failed))},f=new b;"undefined"==typeof wp&&(window.wp={}),wp.wallets={viewModels:{wallets:f}},a(".dashed-slug-wallets").filter(".deposit,.withdraw,.move,.balance,.transactions").each(function(a,b){ko.applyBindings(f,b)}),f.coins().length&&f.selectedCoin(f.coins()[0].symbol),f.currentPage(1),a("html").on("wallets_do_move wallets_do_withdraw",function(a,b){"success"!=b.result?(e(b),a.preventDefault()):f.currentPage(f.currentPage())}),a("html").on("wallets_do_move",function(a,b,c,d,e,g){"success"==b.result&&(f.resetMove(),alert(sprintf(wallets_ko_i18n.submit_tx,d,c)))}),a("html").on("wallets_do_withdraw",function(a,b,c,d,e,g,h){"success"==b.result&&(f.resetWithdraw(),alert(sprintf(wallets_ko_i18n.submit_wd,d,c,e)))}),setTimeout(function(){f.loadCoins(),c();var a=parseFloat(walletsUserData.pollIntervalCoinInfo);a&&setInterval(function(){"undefined"!=typeof window.document.hidden&&window.document.hidden||f.loadCoins()},60*a*1e3)},1e3),setTimeout(function(){f.loadTransactions();var a=parseFloat(walletsUserData.pollIntervalTransactions);a&&setInterval(function(){"undefined"!=typeof window.document.hidden&&window.document.hidden||f.loadTransactions()},60*a*1e3)},2e3),window.document.addEventListener("visibilitychange",function(){window.document.hidden||f.loadCoins()})})}(jQuery);